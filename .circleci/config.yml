version: 2
jobs:
  test:
    docker:
      - image: mcr.microsoft.com/dotnet/core/sdk:2.2
    steps:
      - run: dotnet test Test/Test.csproj
  build:
    docker:
      - image: circleci/buildpack-deps:bionic
      # - image: mcr.microsoft.com/dotnet/core/sdk:2.2
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT: 1
      - CAKE_VERSION: 0.32.1
    steps:
      - run: sudo sh -c 'echo "deb [arch=amd64] https://apt-mo.trafficmanager.net/repos/dotnet-release/ trusty main" > /etc/apt/sources.list.d/dotnetdev.list'
      - run: sudo apt-key adv --keyserver apt-mo.trafficmanager.net --recv-keys 417A0893
      - run: sudo apt-get update
      - run: sudo apt-get install dotnet-dev-1.0.0-preview2.1-003177
      - run: sudo apt update
      - run: sudo apt install gnupg ca-certificates
      - run: sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 3FA7E0328081BFF6A14DA29AA6A19B38D3D831EF
      - run: echo "deb https://download.mono-project.com/repo/ubuntu stable-bionic main" | sudo tee /etc/apt/sources.list.d/mono-official-stable.list
      - run: sudo apt update && sudo apt install -y mono-complete
      - checkout
      # - restore_cache:
      #     keys:
      #       - cake-{{ Environment.CAKE_VERSION }}
      - run: ./build.sh
      # - save_cache:
      #     key: cake-{{ Environment.CAKE_VERSION }}
      #     paths:
      #       - ~/sift-dotnet/tools
      - run: ./build.sh --target=generate
      - run: ./build.sh --target=build
